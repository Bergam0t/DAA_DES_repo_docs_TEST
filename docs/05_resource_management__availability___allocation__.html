<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>resource_management__availability___allocation__ – HEMS Simulation Documentation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-5d2e30ad26079c1dae90a1fd11eba2b9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01_web_application_interface__streamlit__.html">Components</a></li><li class="breadcrumb-item"><a href="./05_resource_management__availability___allocation__.html">Chapter 5: Resource Management (Availability &amp; Allocation)</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">HEMS Simulation Documentation</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorial: DAA_DES</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Components</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_web_application_interface__streamlit__.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 1: Web Application Interface (Streamlit)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_simulation_engine__patient_journey__.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 2: Simulation Engine (Patient Journey)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_patient_entity_.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 3: Patient Entity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_hems_resource_entity_.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 4: HEMS Resource Entity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_resource_management__availability___allocation__.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Chapter 5: Resource Management (Availability &amp; Allocation)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_stochastic_modeling__distributions__.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 6: Stochastic Modeling (Distributions)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_simulation_runner___parallelization_.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 7: Simulation Runner &amp; Parallelization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_results_processing___visualization_.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 8: Results Processing &amp; Visualization</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#chapter-5-resource-management-availability-allocation" id="toc-chapter-5-resource-management-availability-allocation" class="nav-link active" data-scroll-target="#chapter-5-resource-management-availability-allocation">Chapter 5: Resource Management (Availability &amp; Allocation)</a>
  <ul class="collapse">
  <li><a href="#what-problem-does-this-solve" id="toc-what-problem-does-this-solve" class="nav-link" data-scroll-target="#what-problem-does-this-solve">What Problem Does This Solve?</a></li>
  <li><a href="#meet-the-dispatch-center-key-roles" id="toc-meet-the-dispatch-center-key-roles" class="nav-link" data-scroll-target="#meet-the-dispatch-center-key-roles">Meet the Dispatch Center: Key Roles</a></li>
  <li><a href="#how-the-simulation-engine-uses-resource-management" id="toc-how-the-simulation-engine-uses-resource-management" class="nav-link" data-scroll-target="#how-the-simulation-engine-uses-resource-management">How the Simulation Engine Uses Resource Management</a></li>
  <li><a href="#explanation" id="toc-explanation" class="nav-link" data-scroll-target="#explanation">Explanation:</a></li>
  <li><a href="#under-the-hood-the-dispatchers-logic-hemsavailability-class" id="toc-under-the-hood-the-dispatchers-logic-hemsavailability-class" class="nav-link" data-scroll-target="#under-the-hood-the-dispatchers-logic-hemsavailability-class">Under the Hood: The Dispatcher’s Logic (<code>HEMSAvailability</code> class)</a>
  <ul class="collapse">
  <li><a href="#initialization-and-resource-pool" id="toc-initialization-and-resource-pool" class="nav-link" data-scroll-target="#initialization-and-resource-pool">1. Initialization and Resource Pool:</a></li>
  <li><a href="#checking-availability-and-preference-preferred_resource_available" id="toc-checking-availability-and-preference-preferred_resource_available" class="nav-link" data-scroll-target="#checking-availability-and-preference-preferred_resource_available">2. Checking Availability and Preference (<code>preferred_resource_available</code>):</a></li>
  <li><a href="#allocating-the-resource-allocate_resource" id="toc-allocating-the-resource-allocate_resource" class="nav-link" data-scroll-target="#allocating-the-resource-allocate_resource">3. Allocating the Resource (<code>allocate_resource</code>):</a></li>
  <li><a href="#releasing-the-resource-return_resource" id="toc-releasing-the-resource-return_resource" class="nav-link" data-scroll-target="#releasing-the-resource-return_resource">4. Releasing the Resource (<code>return_resource</code>):</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01_web_application_interface__streamlit__.html">Components</a></li><li class="breadcrumb-item"><a href="./05_resource_management__availability___allocation__.html">Chapter 5: Resource Management (Availability &amp; Allocation)</a></li></ol></nav></header>




<section id="chapter-5-resource-management-availability-allocation" class="level1">
<h1>Chapter 5: Resource Management (Availability &amp; Allocation)</h1>
<p>In <a href="./04_hems_resource_entity_.html">Chapter 4: HEMS Resource Entity</a>, we learned about the digital profiles representing each helicopter and car in the simulation – the “players” on our team. But how does the simulation decide which player to send when an emergency call comes in? And how does it know if they are even available?</p>
<p>That’s where <strong>Resource Management</strong> comes in. Think of this part of the simulation as the <strong>Dispatch Center</strong> or the <strong>Air Traffic Controller</strong> for our HEMS (Helicopter Emergency Medical Service) units. It keeps track of every resource, knows who is working, who is busy, and who is best suited for the next job.</p>
<section id="what-problem-does-this-solve" class="level2">
<h2 class="anchored" data-anchor-id="what-problem-does-this-solve">What Problem Does This Solve?</h2>
<p>Imagine a 999 call comes in: a serious accident requiring Critical Care (CC). The DAA has several resources: a CC helicopter (H70), an EC (Emergency Care) helicopter (H71), and a CC car (CC72).</p>
<ul>
<li>Which one <em>should</em> go? (Probably the CC helicopter, H70, is preferred).</li>
<li>Is H70 actually working right now (on shift)?</li>
<li>Is H70 already busy helping someone else?</li>
<li>Is H70 in the hangar for maintenance?</li>
<li>If H70 isn’t available, what’s the next best option? (Maybe the CC car, CC72?).</li>
</ul>
<p>Without a central system managing this, the simulation would be chaos! Resources might get double-booked, or the wrong type of help might be sent. The Resource Management system solves this by acting as the central coordinator for all HEMS resources.</p>
</section>
<section id="meet-the-dispatch-center-key-roles" class="level2">
<h2 class="anchored" data-anchor-id="meet-the-dispatch-center-key-roles">Meet the Dispatch Center: Key Roles</h2>
<p>The Resource Management system, primarily implemented in the <code>class_hems_availability.py</code> file, acts like a dispatcher with a real-time status board. Its main jobs are:</p>
<ol type="1">
<li><strong>Tracking Availability:</strong> It constantly knows the status of each <a href="./04_hems_resource_entity_.html">HEMS Resource Entity</a>.
<ul>
<li><strong>On Shift?</strong> Is the resource scheduled to work at this specific simulation time (based on its rota)?</li>
<li><strong>Busy?</strong> Is it currently assigned to another patient (<code>in_use</code> flag)?</li>
<li><strong>Under Maintenance?</strong> Is it unavailable due to scheduled servicing (<code>being_serviced</code> flag)?</li>
</ul></li>
<li><strong>Determining Preference:</strong> When a <a href="./03_patient_entity_.html">Patient Entity</a> needs help, the system looks at the patient’s needs (e.g., requires ‘CC’ level care) and compares them against the available resources. It uses built-in rules (a hierarchy) to decide which <em>type</em> of resource is <em>preferred</em>. For example:
<ul>
<li>For a CC patient, a CC Helicopter is usually preferred over a CC Car.</li>
<li>A CC Car might be preferred over an EC Helicopter (depending on the specific rules).</li>
</ul></li>
<li><strong>Allocation:</strong> If a suitable and available resource is found based on the preference rules, the system “allocates” or assigns it to the patient.
<ul>
<li>It marks the resource as <code>in_use = True</code>.</li>
<li>It records which resource was assigned to the patient.</li>
</ul></li>
<li><strong>Handling Unavailability:</strong> If the <em>preferred</em> resource isn’t available, it checks the next best option according to the hierarchy. If <em>no</em> suitable resource is available at all, it records that HEMS could not respond.</li>
<li><strong>Release:</strong> Once a resource finishes its task (e.g., patient delivered to hospital, returned to base), the system marks it as available again (<code>in_use = False</code>) so it can be dispatched to the next call.</li>
</ol>
</section>
<section id="how-the-simulation-engine-uses-resource-management" class="level2">
<h2 class="anchored" data-anchor-id="how-the-simulation-engine-uses-resource-management">How the Simulation Engine Uses Resource Management</h2>
<p>Remember the <a href="./02_simulation_engine__patient_journey__.html">Simulation Engine (Patient Journey)</a>? When it creates a new patient, it needs to ask the Resource Management system if help is available.</p>
<p>This happens inside the <code>generate_patient</code> function in <code>des_hems.py</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In des_hems.py (simplified 'generate_patient' function)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ... patient 'pt' is created and details like pt.hems_cc_or_ec are set ...</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Ask Resource Management (self.hems_resources) for a resource</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The type of allocation function depends on the patient's needs (REG vs CC/EC)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> pt.hems_cc_or_ec <span class="op">==</span> <span class="st">'REG'</span>:</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ask for a resource suitable for a 'Regular' case</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    hems_res_list: <span class="bu">list</span> <span class="op">=</span> <span class="cf">yield</span> <span class="va">self</span>.hems_resources.allocate_regular_resource(pt)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ask for a resource suitable for a 'CC' or 'EC' case</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    hems_res_list: <span class="bu">list</span> <span class="op">=</span> <span class="cf">yield</span> <span class="va">self</span>.hems_resources.allocate_resource(pt)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># The result is a list: [Allocated HEMS Resource object or None, reason_code, secondary_resource or None]</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>hems_allocation <span class="op">=</span> hems_res_list[<span class="dv">0</span>] <span class="co"># The main HEMS object if allocated, otherwise None</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>allocation_reason <span class="op">=</span> hems_res_list[<span class="dv">1</span>] <span class="co"># Text describing why this resource was chosen (or why none)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the reason to our results log</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.add_patient_result_row(pt, allocation_reason, <span class="st">"resource_preferred_outcome"</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> hems_allocation <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SUCCESS! A resource was found. Start the patient's journey.</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.env.process(<span class="va">self</span>.patient_journey(hems_allocation, pt, hems_res_list[<span class="dv">2</span>]))</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Record which resource was used</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.add_patient_result_row(pt, hems_allocation.callsign, <span class="st">"resource_use"</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># FAILURE! No suitable HEMS resource was available right now.</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.add_patient_result_row(pt, <span class="st">"No HEMS available"</span>, <span class="st">"queue"</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The patient journey might proceed differently (e.g., handled by land ambulance only)</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In this simplified example, we might just end their journey here.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="explanation" class="level2">
<h2 class="anchored" data-anchor-id="explanation">Explanation:</h2>
<ol type="1">
<li>The code first determines if the patient needs ‘REG’ care or higher (‘CC’/‘EC’).</li>
<li>It then calls the appropriate function from the <code>self.hems_resources</code> object (which is an instance of the <code>HEMSAvailability</code> class from <code>class_hems_availability.py</code>). It passes the <code>pt</code> (Patient Entity) object, which contains the patient’s needs.</li>
<li>The <code>yield</code> keyword pauses the patient’s process while Resource Management figures out the allocation.</li>
<li>Resource Management returns a list (<code>hems_res_list</code>). The most important part is the first item (<code>hems_allocation</code>):
<ul>
<li>If it’s a <a href="./04_hems_resource_entity_.html">HEMS Resource Entity</a> object (like the profile for H70), it means a resource was successfully assigned.</li>
<li>If it’s <code>None</code>, it means no suitable resource was free.</li>
</ul></li>
<li>The code then proceeds based on whether a resource was allocated or not.</li>
</ol>
</section>
<section id="under-the-hood-the-dispatchers-logic-hemsavailability-class" class="level2">
<h2 class="anchored" data-anchor-id="under-the-hood-the-dispatchers-logic-hemsavailability-class">Under the Hood: The Dispatcher’s Logic (<code>HEMSAvailability</code> class)</h2>
<p>Let’s peek inside the <code>class_hems_availability.py</code> file, where the <code>HEMSAvailability</code> class lives. This class manages the pool of resources.</p>
<section id="initialization-and-resource-pool" class="level3">
<h3 class="anchored" data-anchor-id="initialization-and-resource-pool">1. Initialization and Resource Pool:</h3>
<p>When the simulation starts, <code>HEMSAvailability</code> reads the resource details (from files like <code>HEMS_ROTA.csv</code>) and creates a <a href="./04_hems_resource_entity_.html">HEMS Resource Entity</a> object for each one. It also calculates their maintenance schedules. These objects are stored in a special container called a <code>simpy.FilterStore</code>. Think of this store as the dispatcher’s cabinet holding all the resource files.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In class_hems_availability.py (Simplified __init__ and prep_HEMS_resources)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> simpy</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> class_hems <span class="im">import</span> HEMS <span class="co"># The blueprint for a resource</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HEMSAvailability():</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, env, sim_start_date, ...):</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.env <span class="op">=</span> env <span class="co"># The simulation environment</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.store <span class="op">=</span> simpy.FilterStore(env) <span class="co"># The 'cabinet' for resources</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.serviceStore <span class="op">=</span> simpy.FilterStore(env) <span class="co"># A separate cabinet for resources being serviced</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.HEMS_resources_list <span class="op">=</span> [] <span class="co"># Temporary list to hold resources before putting in store</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.active_callsign_groups <span class="op">=</span> <span class="bu">set</span>() <span class="co"># Track busy crews</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.active_registrations <span class="op">=</span> <span class="bu">set</span>() <span class="co"># Track busy vehicles</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.active_callsigns <span class="op">=</span> <span class="bu">set</span>() <span class="co"># Track busy callsigns</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Read data and create resource objects</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.prep_HEMS_resources()</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Put the created resource objects into the main store</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.populate_store()</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Perform initial check for servicing</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... daily servicing check setup ...</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prep_HEMS_resources(<span class="va">self</span>):</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Read HEMS details from CSV files (Rotas, Registrations, Servicing rules)</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        HEMS_RESOURCES_DATA <span class="op">=</span> pd.read_csv(<span class="st">"actual_data/HEMS_ROTA.csv"</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... merge with other data like servicing history ...</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Loop through each resource defined in the data</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index, row <span class="kw">in</span> HEMS_RESOURCES_DATA.iterrows():</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate the specific maintenance schedule for this vehicle</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>            service_df <span class="op">=</span> <span class="va">self</span>.calculate_service_dates(row[<span class="st">'registration'</span>], ...) <span class="co"># Complex logic here</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a HEMS object using the blueprint</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>            hems_object <span class="op">=</span> HEMS(</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>                callsign<span class="op">=</span>row[<span class="st">'callsign'</span>],</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>                vehicle_type<span class="op">=</span>row[<span class="st">'vehicle_type'</span>],</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>                category<span class="op">=</span>row[<span class="st">'category'</span>],</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>                <span class="co"># ... other details like rota times ...</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>                servicing_schedule<span class="op">=</span>service_df <span class="co"># Attach the calculated schedule</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add the new resource object to our list</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.HEMS_resources_list.append(hems_object)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> populate_store(<span class="va">self</span>):</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Put each created HEMS object into the SimPy store</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> h <span class="kw">in</span> <span class="va">self</span>.HEMS_resources_list:</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.store.put(h)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="checking-availability-and-preference-preferred_resource_available" class="level3">
<h3 class="anchored" data-anchor-id="checking-availability-and-preference-preferred_resource_available">2. Checking Availability and Preference (<code>preferred_resource_available</code>):</h3>
<p>This is the core logic for finding the best match. It loops through the resources in the <code>store</code> and checks their status and capabilities against the patient’s needs.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In class_hems_availability.py (Simplified preferred_resource_available for CC/EC)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> preferred_resource_available(<span class="va">self</span>, pt: Patient) <span class="op">-&gt;</span> <span class="bu">list</span>:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        hems: HEMS <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span> <span class="co"># Placeholder for the best resource found</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        preferred <span class="op">=</span> <span class="dv">999</span> <span class="co"># Lower number is better preference (1 = best)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        preferred_lookup <span class="op">=</span> <span class="dv">0</span> <span class="co"># Code indicating which rule matched</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        preferred_care_category <span class="op">=</span> pt.hems_cc_or_ec <span class="co"># e.g., 'CC'</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Look through all resources currently in the main store (not busy, not servicing)</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        h: HEMS</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> h <span class="kw">in</span> <span class="va">self</span>.store.items:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># --- Basic Availability Checks ---</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Is the resource currently marked as busy?</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Is the crew already assigned to another task? (Check active sets)</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Is the vehicle already assigned? (Check active sets)</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Is it actually scheduled to be working now?</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (h.in_use <span class="kw">or</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>                h.callsign_group <span class="kw">in</span> <span class="va">self</span>.active_callsign_groups <span class="kw">or</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>                h.registration <span class="kw">in</span> <span class="va">self</span>.active_registrations <span class="kw">or</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                <span class="kw">not</span> h.hems_resource_on_shift(pt.hour, pt.qtr)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                <span class="co"># </span><span class="al">NOTE</span><span class="co">: Servicing check happens daily, moving resources to serviceStore</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>               ):</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span> <span class="co"># Skip this resource, it's not available</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># --- Preference Logic (Example for CC/EC) ---</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Rule 1: Preferred care category &amp; Helicopter? (BEST)</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> h.category <span class="op">==</span> preferred_care_category <span class="kw">and</span> h.vehicle_type <span class="op">==</span> <span class="st">"helicopter"</span>:</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>                hems <span class="op">=</span> h</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>                preferred <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>                preferred_lookup <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> [hems, <span class="va">self</span>.resource_allocation_lookup(preferred_lookup)] <span class="co"># Found best, stop searching</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Rule 2: Preferred care category &amp; Car? (Good)</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> h.category <span class="op">==</span> preferred_care_category: <span class="co"># Vehicle type must be Car</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> preferred <span class="op">&gt;</span> <span class="dv">2</span>: <span class="co"># If we haven't found a better match yet</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>                    hems <span class="op">=</span> h</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>                    preferred <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>                    preferred_lookup <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Rule 3/4: If patient needs CC, is an EC resource available?</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> preferred_care_category <span class="op">==</span> <span class="st">'CC'</span>:</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> h.category <span class="op">==</span> <span class="st">'EC'</span> <span class="kw">and</span> h.vehicle_type <span class="op">==</span> <span class="st">'helicopter'</span>:</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">if</span> preferred <span class="op">&gt;</span> <span class="dv">3</span>: hems <span class="op">=</span> h<span class="op">;</span> preferred <span class="op">=</span> <span class="dv">3</span><span class="op">;</span> preferred_lookup <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> h.category <span class="op">==</span> <span class="st">'EC'</span>: <span class="co"># Must be Car</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">if</span> preferred <span class="op">&gt;</span> <span class="dv">4</span>: hems <span class="op">=</span> h<span class="op">;</span> preferred <span class="op">=</span> <span class="dv">4</span><span class="op">;</span> preferred_lookup <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Rule 5/6: If patient needs EC, is a CC resource available? (Similar logic)</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ...</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># After checking all resources, return the best one found (or None)</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> hems <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [hems, <span class="va">self</span>.resource_allocation_lookup(preferred_lookup)]</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [<span class="va">None</span>, <span class="va">self</span>.resource_allocation_lookup(<span class="dv">0</span>)] <span class="co"># Code 0 = No resource available</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="allocating-the-resource-allocate_resource" class="level3">
<h3 class="anchored" data-anchor-id="allocating-the-resource-allocate_resource">3. Allocating the Resource (<code>allocate_resource</code>):</h3>
<p>Once the preferred available resource is identified, this function attempts to “take” it from the store and mark it as busy. It uses SimPy’s <code>store.get()</code> mechanism.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In class_hems_availability.py (Simplified allocate_resource for CC/EC)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> allocate_resource(<span class="va">self</span>, pt: Patient):</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        resource_event <span class="op">=</span> <span class="va">self</span>.env.event() <span class="co"># SimPy event to signal completion</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> process(): <span class="co"># Inner function to handle the allocation steps</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 1. Find the best available resource using the logic above</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            pref_res: <span class="bu">list</span> <span class="op">=</span> <span class="va">self</span>.preferred_resource_available(pt)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            primary_resource <span class="op">=</span> pref_res[<span class="dv">0</span>] <span class="co"># The HEMS object or None</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            reason <span class="op">=</span> pref_res[<span class="dv">1</span>] <span class="co"># The reason code</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> primary_resource <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                <span class="co"># No resource found, signal failure immediately</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> resource_event.succeed([<span class="va">None</span>, reason, <span class="va">None</span>])</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 2. Try to 'get' the chosen resource from the store</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># This ensures only one process gets it at a time</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="va">self</span>.store.get(<span class="kw">lambda</span> r: r <span class="op">==</span> primary_resource) <span class="im">as</span> request:</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> <span class="cf">yield</span> request <span class="op">|</span> <span class="va">self</span>.env.timeout(<span class="fl">0.1</span>) <span class="co"># Wait briefly if needed</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> request <span class="kw">in</span> result:</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># SUCCESS: We got the resource!</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                    primary_resource.in_use <span class="op">=</span> <span class="va">True</span> <span class="co"># Mark it as busy</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Add identifiers to sets tracking active resources</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.active_callsign_groups.add(primary_resource.callsign_group)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.active_registrations.add(primary_resource.registration)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.active_callsigns.add(primary_resource.callsign)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Store details in patient object</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>                    pt.hems_callsign_group <span class="op">=</span> primary_resource.callsign_group</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># ... store other details ...</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># (Logic to find a secondary resource like a car if needed is omitted for simplicity)</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                    secondary_resource <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Signal success, returning the allocated resource</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> resource_event.succeed([primary_resource, reason, secondary_resource])</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># FAILURE: Couldn't get the resource (maybe taken by another process?)</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Signal failure</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> resource_event.succeed([<span class="va">None</span>, reason, <span class="va">None</span>])</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.env.process(process()) <span class="co"># Start the allocation process</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> resource_event <span class="co"># Return the event that will eventually hold the result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="releasing-the-resource-return_resource" class="level3">
<h3 class="anchored" data-anchor-id="releasing-the-resource-return_resource">4. Releasing the Resource (<code>return_resource</code>):</h3>
<p>When the <code>patient_journey</code> function in <code>des_hems.py</code> finishes, it calls this function to put the resource back into the available pool.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In class_hems_availability.py (Simplified return_resource)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> return_resource(<span class="va">self</span>, resource: HEMS, secondary_resource: HEMS <span class="op">|</span> <span class="va">None</span>):</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mark the primary resource as not busy</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        resource.in_use <span class="op">=</span> <span class="va">False</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove identifiers from the active sets</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.active_callsign_groups.discard(resource.callsign_group)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.active_registrations.discard(resource.registration)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.active_callsigns.discard(resource.callsign)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Put the resource object back into the main store</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.store.put(resource)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (Repeat for secondary resource if applicable)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> secondary_resource <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>             secondary_resource.in_use <span class="op">=</span> <span class="va">False</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>             <span class="co"># ... remove from active sets ...</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>             <span class="va">self</span>.store.put(secondary_resource)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Simplified Allocation Flow Diagram:</strong></p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant Engine as Simulation Engine (des_hems.py)
    participant ResMgmt as Resource Management (HEMSAvailability)
    participant Store as SimPy FilterStore
    participant H70 as HEMS Resource (in Store)

    Engine-&gt;&gt;+ResMgmt: allocate_resource(Patient needing 'CC')
    ResMgmt-&gt;&gt;ResMgmt: preferred_resource_available(Patient) finds H70 is best
    ResMgmt-&gt;&gt;+Store: Get H70 resource object
    Store--&gt;&gt;-ResMgmt: Provide H70 object
    ResMgmt-&gt;&gt;H70: Set in_use = True
    ResMgmt-&gt;&gt;ResMgmt: Add H70 details to active sets
    ResMgmt--&gt;&gt;-Engine: Return H70 object (Success)

    Note over Engine, H70: Patient Journey Simulation...

    Engine-&gt;&gt;+ResMgmt: return_resource(H70)
    ResMgmt-&gt;&gt;H70: Set in_use = False
    ResMgmt-&gt;&gt;ResMgmt: Remove H70 details from active sets
    ResMgmt-&gt;&gt;+Store: Put H70 resource object back
    Store--&gt;&gt;-ResMgmt: Acknowledge return
    ResMgmt--&gt;&gt;-Engine: Resource returned
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>The Resource Management system (<code>HEMSAvailability</code>) is the crucial dispatch center of our simulation. It maintains a real-time view of all <a href="./04_hems_resource_entity_.html">HEMS Resource Entities</a>, checking if they are on shift, free, and not under maintenance. When a <a href="./03_patient_entity_.html">Patient Entity</a> needs help, it uses a defined hierarchy to select the <em>preferred</em> available resource, allocates it, and ensures it’s properly released afterwards. This prevents conflicts and ensures the simulation realistically models how resources are assigned based on availability and operational rules.</p>
<p>But how does the simulation decide <em>how long</em> each step takes (like mobilisation time or time on scene)? And how does it determine patient characteristics like age or the type of emergency? These aren’t fixed numbers; they involve randomness and probability. That’s what we’ll explore next.</p>
<p><strong>Next:</strong> <a href="./06_stochastic_modeling__distributions__.html">Chapter 6: Stochastic Modeling (Distributions)</a></p>
<hr>
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>