<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>simulation_engine__patient_journey__ – HEMS Simulation Documentation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ddd961a2510921635943dfbbd19534c4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">HEMS Simulation Documentation</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-components" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Components</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-components">    
        <li>
    <a class="dropdown-item" href="./01_web_application_interface__streamlit__.html">
 <span class="dropdown-text">Web Application Interface (Streamlit)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02_simulation_engine__patient_journey__.html">
 <span class="dropdown-text">Simulation Engine (Patient Journey)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03_patient_entity_.html">
 <span class="dropdown-text">Patient Entity</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04_hems_resource_entity_.html">
 <span class="dropdown-text">HEMS Resource Entity</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05_resource_management__availability___allocation__.html">
 <span class="dropdown-text">Resource Management (Availability &amp; Allocation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06_stochastic_modeling__distributions__.html">
 <span class="dropdown-text">Stochastic Modeling (Distributions)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07_simulation_runner___parallelization_.html">
 <span class="dropdown-text">Simulation Runner &amp; Parallelization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./08_results_processing___visualization_.html">
 <span class="dropdown-text">Results Processing &amp; Visualization</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#chapter-2-simulation-engine-patient-journey" id="toc-chapter-2-simulation-engine-patient-journey" class="nav-link active" data-scroll-target="#chapter-2-simulation-engine-patient-journey">Chapter 2: Simulation Engine (Patient Journey)</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="chapter-2-simulation-engine-patient-journey" class="level1">
<h1>Chapter 2: Simulation Engine (Patient Journey)</h1>
<p>In <a href="./01_web_application_interface__streamlit__.html">Chapter 1: Web Application Interface (Streamlit)</a>, we saw the control panel that lets you configure and run the DAA_DES simulation. But what actually happens when you click that “Run Simulation” button? How does the simulation <em>know</em> what to do?</p>
<p>This chapter introduces the <strong>Simulation Engine</strong>, the heart of our simulation. Think of it as the <strong>director of a play</strong>. The play is the Devon Air Ambulance service operating over a period (like a year). The actors are the individual patient cases that arise. The Simulation Engine directs each patient actor through their scenes (the stages of their interaction with the service), making sure everything happens in the right order and according to the rules.</p>
<p><strong>What Problem Does This Solve?</strong></p>
<p>Imagine trying to manually figure out the entire sequence of events for thousands of potential emergency calls over a year. When does a call come in? Is a helicopter needed? Is one available? How long does it take to get ready, fly to the scene, treat the patient, fly to the hospital, and become ready again? This is incredibly complex!</p>
<p>The Simulation Engine automates this entire process. It manages the flow of time and events within the simulated world, allowing us to model the complex interactions between calls, resources, and patient outcomes.</p>
<p><strong>The Director’s Script: Key Roles of the Engine</strong></p>
<p>The Simulation Engine, primarily implemented in the <code>des_hems.py</code> file, handles several crucial tasks:</p>
<ol type="1">
<li><strong>Generating Calls:</strong> It creates new patient incidents based on realistic patterns. For example, it knows that more calls tend to happen during certain hours of the day or certain times of the year. It uses probabilities (<a href="./06_stochastic_modeling__distributions__.html">Stochastic Modeling (Distributions)</a>) to decide <em>when</em> the next call arrives.</li>
<li><strong>Assessing the Situation:</strong> For each call, it determines the type of incident (based on simulated medical codes like AMPDS) and decides if a Helicopter Emergency Medical Service (HEMS) resource (like a helicopter or critical care car) is potentially needed.</li>
<li><strong>Finding Resources:</strong> If HEMS is needed, it checks if a suitable and available <a href="./04_hems_resource_entity_.html">HEMS Resource Entity</a> exists. This involves checking schedules (rotas), current status (is it already on a job? is it being serviced?), and rules for allocation (<a href="./05_resource_management__availability___allocation__.html">Resource Management (Availability &amp; Allocation)</a>).</li>
<li><strong>Directing the Journey:</strong> If a resource is assigned, the engine guides the <a href="./03_patient_entity_.html">Patient Entity</a> and the assigned resource through the key stages of the mission. It uses time delays (again, based on <a href="./06_stochastic_modeling__distributions__.html">Stochastic Modeling (Distributions)</a>) for each step:
<ul>
<li><strong>Mobilisation:</strong> Time taken for the crew to get ready and depart.</li>
<li><strong>Travel to Scene:</strong> Time taken to fly or drive to the incident location.</li>
<li><strong>On Scene:</strong> Time spent assessing and treating the patient.</li>
<li><strong>Travel to Hospital:</strong> Time taken to transport the patient (if needed).</li>
<li><strong>Handover:</strong> Time spent handing the patient over to hospital staff.</li>
<li><strong>Clear:</strong> Time taken to become available for the next call (e.g., returning to base, refuelling).</li>
</ul></li>
<li><strong>Recording Events:</strong> Throughout this journey, the engine logs every important event and timestamp. This data is crucial for later analysis (<a href="./08_results_processing___visualization_.html">Results Processing &amp; Visualization</a>).</li>
</ol>
<p><strong>A Patient’s Journey: An Example</strong></p>
<p>Let’s follow a simplified journey directed by the Simulation Engine:</p>
<ol type="1">
<li><strong>Call Arrives:</strong> The engine decides (based on its internal clock and probability distributions) that a call comes in at <code>simulation time = 125.5 minutes</code>.</li>
<li><strong>Patient Created:</strong> A new <a href="./03_patient_entity_.html">Patient Entity</a> (let’s call them Patient 42) is created. The engine assigns them characteristics (like age, type of emergency - maybe a ‘CC’ or Critical Care case).</li>
<li><strong>Resource Check:</strong> The engine asks the <a href="./05_resource_management__availability___allocation__.html">Resource Management (Availability &amp; Allocation)</a> system: “Is a Critical Care helicopter available?”</li>
<li><strong>Resource Assigned:</strong> Let’s say Helicopter H70 is free. The engine assigns H70 to Patient 42.</li>
<li><strong>Mobilisation:</strong> The engine looks up how long mobilisation usually takes (say, a random value like 5.2 minutes based on a distribution). It tells the simulation clock to advance by 5.2 minutes. <code>simulation time = 130.7 minutes</code>. H70 is now mobile.</li>
<li><strong>Travel to Scene:</strong> The engine determines travel time (e.g., 12.1 minutes). Clock advances. <code>simulation time = 142.8 minutes</code>. H70 arrives on scene.</li>
<li><strong>On Scene:</strong> Engine determines time on scene (e.g., 25.6 minutes). Clock advances. <code>simulation time = 168.4 minutes</code>. H70 leaves the scene (perhaps flying to hospital).</li>
<li><em>(…and so on for travel to hospital, handover, and becoming clear…)</em></li>
<li><strong>Resource Freed:</strong> Once H70 completes its final step (e.g., returning to base), the engine tells the <a href="./05_resource_management__availability___allocation__.html">Resource Management (Availability &amp; Allocation)</a> system that H70 is available again.</li>
</ol>
<p>The engine manages hundreds or thousands of these patient journeys simultaneously, making sure the shared resources (helicopters, cars) are used correctly and that time progresses logically.</p>
<p><strong>Under the Hood: Code Glimpses</strong></p>
<p>The core logic resides mainly in <code>des_hems.py</code>. We use a Python library called <code>simpy</code> to handle the simulation time and events.</p>
<ul>
<li><p><strong>Generating Calls (<code>generate_calls</code> in <code>des_hems.py</code>):</strong> This function runs continuously. It figures out <em>when</em> the next call should happen based on time-of-day patterns and random chance.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified concept from des_hems.py</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_calls(<span class="va">self</span>):</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">self</span>.env.now <span class="op">&lt;</span> (<span class="va">self</span>.sim_duration <span class="op">+</span> <span class="va">self</span>.warm_up_duration):</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Figure out time until the next call based on distributions</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        time_to_next_call <span class="op">=</span> <span class="va">self</span>._calculate_interarrival_time() <span class="co"># Uses distributions</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2. Tell simpy to pause (wait) for that duration</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> <span class="va">self</span>.env.timeout(time_to_next_call)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3. Time's up! Create the patient process</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (Get details like day, hour, etc.)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        dow, hod, _, month, qtr, dt <span class="op">=</span> <span class="va">self</span>.utils.date_time_of_call(...)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.env.process(<span class="va">self</span>.generate_patient(dow, hod, ..., dt))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>yield self.env.timeout(...)</code> is simpy’s way of saying “pause this process and advance the simulation clock”. <code>self.env.process(...)</code> starts a new, independent process for the patient.</p></li>
<li><p><strong>Creating a Patient (<code>generate_patient</code> in <code>des_hems.py</code>):</strong> This function gets called by <code>generate_calls</code>. It sets up the patient’s details and tries to get a HEMS resource.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified concept from des_hems.py</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_patient(<span class="va">self</span>, dow, hod, ...):</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.patient_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    pt <span class="op">=</span> Patient(<span class="va">self</span>.patient_counter) <span class="co"># Create Patient object (Chapter 3)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign details based on distributions (Chapter 6)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    pt.hour <span class="op">=</span> hod</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    pt.ampds_card <span class="op">=</span> <span class="va">self</span>.utils.ampds_code_selection(pt.hour)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    pt.hems_cc_or_ec <span class="op">=</span> <span class="va">self</span>.utils.care_category_selection(pt.ampds_card)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... other patient details ...</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Record arrival event</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.add_patient_result_row(pt, <span class="st">"arrival"</span>, <span class="st">"arrival_departure"</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ask Resource Management (Chapter 5) for a HEMS resource</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This uses the HEMSAvailability class (Chapter 5)</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    hems_res_list <span class="op">=</span> <span class="cf">yield</span> <span class="va">self</span>.hems_resources.allocate_resource(pt)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    hems_allocation <span class="op">=</span> hems_res_list[<span class="dv">0</span>] <span class="co"># The actual HEMS object or None</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> hems_allocation <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If successful, start the main journey process</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.env.process(<span class="va">self</span>.patient_journey(hems_allocation, pt, ...))</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If no resource available, handle that (e.g., record it)</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_patient_result_row(pt, <span class="st">"No HEMS available"</span>, <span class="st">"queue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This creates a <a href="./03_patient_entity_.html">Patient Entity</a>, determines their needs, and interacts with the <a href="./05_resource_management__availability___allocation__.html">Resource Management (Availability &amp; Allocation)</a> system (<code>self.hems_resources</code>). If a resource is found, it kicks off the <code>patient_journey</code>.</p></li>
<li><p><strong>Simulating the Journey Steps (<code>patient_journey</code> in <code>des_hems.py</code>):</strong> This function simulates the time delays for each stage of the patient’s interaction.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified concept from des_hems.py</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> patient_journey(<span class="va">self</span>, hems_res: HEMS, patient: Patient, ...):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Mobilisation Time ---</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        mobilisation_time <span class="op">=</span> <span class="va">self</span>.utils.activity_time(patient.hems_vehicle_type, <span class="st">'time_mobile'</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> <span class="va">self</span>.env.timeout(mobilisation_time) <span class="co"># Wait for mobilisation</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_patient_result_row(patient, <span class="st">"HEMS mobile"</span>, <span class="st">"queue"</span>) <span class="co"># Record event</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Time To Scene ---</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        tts_time <span class="op">=</span> <span class="va">self</span>.utils.activity_time(patient.hems_vehicle_type, <span class="st">'time_to_scene'</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> <span class="va">self</span>.env.timeout(tts_time) <span class="co"># Wait for travel</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_patient_result_row(patient, <span class="st">"HEMS on scene"</span>, <span class="st">"queue"</span>) <span class="co"># Record event</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Time On Scene ---</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        tos_time <span class="op">=</span> <span class="va">self</span>.utils.activity_time(patient.hems_vehicle_type, <span class="st">'time_on_scene'</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> <span class="va">self</span>.env.timeout(tos_time) <span class="co"># Wait while on scene</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_patient_result_row(patient, <span class="st">"HEMS leaving scene"</span>, <span class="st">"queue"</span>) <span class="co"># Record event</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... other steps like travel to hospital, clear time ...</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Resource Becomes Free ---</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VERY important: tell Resource Management the resource is available again</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> hems_res <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.hems_resources.return_resource(hems_res, ...)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.add_patient_result_row(patient, hems_res.callsign, <span class="st">"resource_use_end"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Again, <code>yield self.env.timeout(...)</code> makes the simulation clock move forward. The <code>self.add_patient_result_row(...)</code> function logs what happened and when, building up the data needed for <a href="./08_results_processing___visualization_.html">Results Processing &amp; Visualization</a>. The <code>finally</code> block ensures the resource is always returned.</p></li>
</ul>
<p><strong>How it Fits Together</strong></p>
<p>Here’s a simplified diagram showing the main interactions when a new call arrives:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant GenCalls as generate_calls (Engine)
    participant GenPat as generate_patient (Engine)
    participant Pt as Patient Entity (Data)
    participant ResMgmt as HEMSAvailability (Resource Logic)
    participant Journey as patient_journey (Engine)

    GenCalls-&gt;&gt;GenCalls: Calculate time to next call
    GenCalls-&gt;&gt;+GenPat: Start new patient process()
    GenPat-&gt;&gt;Pt: Create Patient()
    GenPat-&gt;&gt;GenPat: Assign patient details (AMPDS, CC/EC)
    GenPat-&gt;&gt;+ResMgmt: allocate_resource(patient)?
    ResMgmt--&gt;&gt;-GenPat: Return HEMS Resource (or None)
    alt Resource Available
        GenPat-&gt;&gt;+Journey: Start patient_journey(HEMS, Patient)
        Journey-&gt;&gt;Journey: yield timeout (mobilisation)
        Journey-&gt;&gt;Journey: Record 'Mobile' event
        Journey-&gt;&gt;Journey: yield timeout (travel to scene)
        Journey-&gt;&gt;Journey: Record 'On Scene' event
        Journey-&gt;&gt;Journey: ... other steps ...
        Journey-&gt;&gt;-ResMgmt: return_resource(HEMS)
    else No Resource Available
        GenPat-&gt;&gt;GenPat: Record 'No HEMS' event
    end

</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>The Simulation Engine (<code>des_hems.py</code> containing <code>generate_calls</code>, <code>generate_patient</code>, <code>patient_journey</code>) acts as the central orchestrator. It creates patients, interacts with the resource management system, and steps through the time-based events of each patient’s journey, using data structures like the <a href="./03_patient_entity_.html">Patient Entity</a> and rules defined in <a href="./05_resource_management__availability___allocation__.html">Resource Management (Availability &amp; Allocation)</a>.</p>
<p><strong>Conclusion</strong></p>
<p>The Simulation Engine is the core logic that drives the DAA_DES simulation. It acts like a director, generating patient calls based on realistic patterns and guiding each patient (and the assigned HEMS resource) through the stages of their journey – from the initial call, through mobilisation, scene arrival, treatment, and finally becoming clear. It manages simulation time and ensures events happen in the correct sequence, using probabilistic timings defined in <a href="./06_stochastic_modeling__distributions__.html">Stochastic Modeling (Distributions)</a>. This engine allows us to model the complex, dynamic behaviour of the HEMS system.</p>
<p>Now that we understand how the overall flow is managed, let’s look more closely at the main ‘actor’ in our simulation: the patient.</p>
<p><strong>Next:</strong> <a href="./03_patient_entity_.html">Chapter 3: Patient Entity</a></p>
<hr>
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>